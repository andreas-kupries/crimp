# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0
## (c) 2011-2016 Andreas Kupries
# # ## ### ##### ######## ############# #####################

kt check Tcl     8.5
kt check tcltest 2

kt source support/synth.tcl

kt local support crimp::core
kt local testing crimp

# -------------------------------------------------------------------------
## Geometry manipulation. Warp image through a projective transform.
# -------------------------------------------------------------------------

test crimp-warp-projective-1.0 {image warp projective, wrong\#args, not enough} -body {
    crimp warp projective
} -returnCodes error -result {wrong # args: should be "::crimp::warp::projective image transform"}

test crimp-warp-projective-1.1 {image warp projective, wrong\#args, not enough} -body {
    crimp warp projective IMAGE
} -returnCodes error -result {wrong # args: should be "::crimp::warp::projective image transform"}

test crimp-warp-projective-1.2 {image warp projective, wrong\#args, too many} -body {
    crimp warp projective IMAGE T toomuch
} -returnCodes error -result {wrong # args: should be "::crimp::warp::projective image transform"}

test crimp-warp-projective-1.3 {image warp projective, invalid arguments, bad option} -body {
    crimp warp projective -bogus FOO
} -returnCodes error -result {Expected -interpolate, got "-bogus"}

test crimp-warp-projective-1.4 {image warp projective, invalid arguments, bad option} -body {
    crimp warp projective -interpolate FOO
} -returnCodes error -result {Expected one of nneighbour, bilinear, or bicubic, got "FOO"}

# 2 args: input, t
# option -interpolate: bilinear (default), bicubic, nneighbour
# supported inputs: grey8 grey16 grey32 rgb rgba hsv float fpcomplex
# TODO 

# -------------------------------------------------------------------------

set n 2
foreach itype [greys] max {255 65535 4294967295} {

    set     map {}
    lappend map @@ $max
    lappend map @1 [expr {$max-1}]
    lappend map @2 [expr {$max-2}]
    lappend map @3 [expr {$max-3}]
    lappend map @4 [expr {$max-4}]

    test crimp-warp-projective-${n}.0 "image warp projective, $itype, nearest neighbour, reflect" -body {
        astcl [crimp warp projective \
                   -interpolate nneighbour [$itype] \
                   [crimp transform reflect line {2 4} {4 0}]]
        # permutations of the main diagonal
    } -result [iconst $itype 0 0 8 7 {
        0 0  0  0  4  0  0 0
        0 0  14 9  8  3  0 0
        0 24 19 13 7  2  1 0
        0 23 18 17 12 6  0 0
        0 0  22 16 11 10 5 0
        0 0  0  21 15 0  0 0
        0 0  0  20 0  0  0 0
    }]

    test crimp-warp-projective-${n}.1 "image warp projective, $itype, nearest neighbour, rotate" -body {
        astcl [crimp warp projective \
                   -interpolate nneighbour [$itype] \
                   [crimp transform rotate 45 {2 2}]]
    } -result [iconst $itype -1 -1 7 7 {
        0 0 0  4  0  0  0 
        0 0 3  8  9  0  0 
        0 1 7  8  13 19 0 
        0 6 6  12 18 18 24
        0 5 11 16 17 23 0 
        0 0 15 16 21 0  0 
        0 0 0  20 0  0  0 
    }]

    # validate...
    test crimp-warp-projective-${n}.2 "image warp projective, $itype, bilinear (default), reflect" -body {
        astcl [crimp warp projective [$itype] \
                   [crimp transform reflect line {2 4} {4 0}]]
    } -result [iconst $itype 0 0 8 7 [string map $map {
        0 0  0  4  4  0   4   0  
        0 0  8  10 6  1   @2  2  
        2 8  17 13 8  3   0   0  
        0 18 19 15 10 6   1   @2
        0 4  22 17 12 8   3   @@
        0 0  8  19 15 10  2   @1
        0 0  0  11 17 @1  20  0  
    }]]

    test crimp-warp-projective-${n}.3 "image warp projective, $itype, bilinear (default), rotate" -body {
        astcl [crimp warp projective [$itype] \
                   [crimp transform rotate 45 {2 2}]]
    } -result [iconst $itype -1 -1 7 7 [string map $map {
        0   4   0  3  4  0  0 
        1   @1  2  6  6  11 0 
        @2  0   4  9  13 5  10
        0   3   7  12 16 20 18
        2   6   10 14 19 19 4 
        3   9   13 17 18 3  0 
        0   @@  16 17 3  0  0 
    }]]

    test crimp-warp-projective-${n}.4 "image warp projective, $itype, bicubic, reflect" -body {
        astcl [crimp warp projective \
                   -interpolate bicubic [$itype] \
                   [crimp transform reflect line {2 4} {4 0}]]

    } -result [iconst $itype 0 0 8 7 {
        0 0  0  3  4  4  0 0
        0 0  8  11 6  3  2 0
        5 14 17 15 9  3  2 0
        0 15 21 15 9  8  2 0
        0 8  16 19 13 8  3 1
        0 0  10 21 19 12 1 0
        0 0  0  12 19 1  0 0
    }]

    test crimp-warp-projective-${n}.5 "image warp projective, $itype, bicubic, rotate" -body {
        astcl [crimp warp projective \
                   -interpolate bicubic [$itype] \
                   [crimp transform rotate 45 {2 2}]]
    } -result [iconst $itype -1 -1 7 7 {
        0 0  4  3  2  0  0 
        0 1  3  6  7  4  0 
        0 2  4  9  12 11 8 
        1 2  8  9  15 23 10
        2 7  12 14 21 15 9 
        0 11 14 20 14 8  0 
        0 1  19 14 8  0  0 
    }]

    incr n
}

# -------------------------------------------------------------------------
## Handling of input location: Transformed coordinates of input location, to grid.

# TODO

# -------------------------------------------------------------------------
cleanupTests

# Local variables:
# mode: tcl
# indent-tabs-mode: nil
# End:
