# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0
## (c) 2011-2016 Andreas Kupries
# # ## ### ##### ######## ############# #####################

kt check Tcl     8.5
kt check tcltest 2

kt source support/synth.tcl

kt local support crimp::core
kt local testing crimp

# -------------------------------------------------------------------------
## Thresholding
##  global - single threshold, various relations
##  local  - spatially varying threshold, various relations.
# -------------------------------------------------------------------------

test crimp-threshold-1.0 {image thresholding, wrong\#args, not enough} -body {
    crimp threshold
} -returnCodes error -result [wa crimp threshold subcommand ?argument ...?]

test crimp-threshold-1.1 {image thresholding, invalid method} -body {
    crimp threshold BOGUS
} -returnCodes error -result {unknown or ambiguous subcommand "BOGUS": must be global, or local}

test crimp-threshold-1.2 {image thresholding, invalid method} -body {
    crimp threshold global BOGUS
} -returnCodes error -result {unknown or ambiguous subcommand "BOGUS": must be above, below, inside, mean, median, middle, otsu, or outside}

# -------------------------------------------------------------------------
## TODO: local
## TODO (implementation): grey16, grey32
# -------------------------------------------------------------------------
# below    P <= T          ? WHITE : BLACK (highlight/object pixels below or equal to threshold T)
# above    P >  T          ? WHITE : BLACK (!below (P, T))
# inside   MIN <= P <= MAX ? WHITE : BLACK
# outside  (!inside (MIN, P, MAX))
# otsu     above (P, otsu)
# middle   above (P, middle), middle = 1/2(Pmin+Pmax)
# mean     above (P, mean),   mean = arithmetic average over all pixels
# median   above (P, median), median over all pixels (half are below, others above)
#
# Note:
# WHITE, BLACK = max-grey-val, 0 for the greyN based types
#              =            1, 0 for the float based types.
# -------------------------------------------------------------------------

test crimp-threshold-2.0 {image thresholding, global, below, wrong\#args, not enough} -body {
    crimp threshold global below
} -returnCodes error -result [wa crimp threshold global below image n]

test crimp-threshold-2.1 {image thresholding, global, below, wrong\#args, not enough} -body {
    crimp threshold global below IMAGE
} -returnCodes error -result [wa crimp threshold global below image n]

test crimp-threshold-2.2 {image thresholding, global, below, wrong\#args, too many} -body {
    crimp threshold global below IMAGE THRESHOLD toomuch
} -returnCodes error -result [wa crimp threshold global below image n]

test crimp-threshold-2.3.0 {image thresholding, global, below, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global below [grey8] 0]]
} -result [trim {
    *....
    .....
    .....
    .....
    .....}]

test crimp-threshold-2.3.1 {image thresholding, global, below, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global below [grey8] 1]]
} -result [trim {
    **...
    .....
    .....
    .....
    .....}]

test crimp-threshold-2.3.2 {image thresholding, global, below, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global below [grey8] 20]]
} -result [trim {
    *****
    *****
    *****
    *****
    *....}]

test crimp-threshold-2.3.3 {image thresholding, global, below, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global below [grey8] 255]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-2.3.4 {image thresholding, global, below, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global below [grey8] 256]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-2.4.0 {image thresholding, global, below, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgb] 0]]
} -result [trim {
    {*..}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-2.4.1 {image thresholding, global, below, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgb] 1]]
} -result [trim {
    {**.}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-2.4.2 {image thresholding, global, below, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgb] 20]]
} -result [trim {
    {***}{**.}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}}]

test crimp-threshold-2.4.3 {image thresholding, global, below, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgb] 255]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-2.4.4 {image thresholding, global, below, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgb] 256]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-2.5.0 {image thresholding, global, below, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgba] 0]]
    # alpha channel is not thresholded
} -result [trim {
    {*..75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-2.5.1 {image thresholding, global, below, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgba] 1]]
    # alpha channel is not thresholded
} -result [trim {
    {**.75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-2.5.2 {image thresholding, global, below, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgba] 20]]
} -result [trim {
    {***75}{**.84}{...85}{...86}{...87}
    {***76}{*..83}{...9.}{...89}{...88}
    {***77}{*..82}{...91}{...98}{...97}
    {***78}{*..81}{...92}{...99}{...96}
    {***79}{*..8.}{...93}{...94}{...95}}]

test crimp-threshold-2.5.3 {image thresholding, global, below, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgba] 255]]
} -result [trim {
    {***75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-2.5.4 {image thresholding, global, below, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global below [rgba] 256]]
} -result [trim {
    {***75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-2.6.0 {image thresholding, global, below, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global below [hsv] 0]]
} -result [trim {
    {*..}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-2.6.1 {image thresholding, global, below, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global below [hsv] 1]]
} -result [trim {
    {**.}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-2.6.2 {image thresholding, global, below, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global below [hsv] 20]]
} -result [trim {
    {***}{**.}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}}]

test crimp-threshold-2.6.3 {image thresholding, global, below, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global below [hsv] 255]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-2.6.4 {image thresholding, global, below, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global below [hsv] 256]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-2.7.0 {image thresholding, global, below, float} -body {
    bw [crimp write 2string tcl [crimp threshold global below [float] 0]]
} -result [trim {
    *....
    .....
    .....
    .....
    .....}]

test crimp-threshold-2.7.1 {image thresholding, global, below, float} -body {
    bw [crimp write 2string tcl [crimp threshold global below [float] -1]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-2.7.2 {image thresholding, global, below, float} -body {
    bw [crimp write 2string tcl [crimp threshold global below [float] 1]]
} -result [trim {
    **...
    .....
    .....
    .....
    .....}]

test crimp-threshold-2.7.3 {image thresholding, global, below, float} -body {
    bw [crimp write 2string tcl [crimp threshold global below [float] 15.5]]
} -result [trim {
    *****
    *****
    *****
    *....
    .....}]

test crimp-threshold-2.7.4 {image thresholding, global, below, float} -body {
    bw [crimp write 2string tcl [crimp threshold global below [float] 20]]
} -result [trim {
    *****
    *****
    *****
    *****
    *....}]

test crimp-threshold-2.7.5 {image thresholding, global, below, float} -body {
    bw [crimp write 2string tcl [crimp threshold global below [float] 255]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-2.7.6 {image thresholding, global, below, float} -body {
    bw [crimp write 2string tcl [crimp threshold global below [float] 256]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

# -------------------------------------------------------------------------

test crimp-threshold-3.0 {image thresholding, global, above, wrong\#args, not enough} -body {
    crimp threshold global above
} -returnCodes error -result [wa crimp threshold global above image n]

test crimp-threshold-3.1 {image thresholding, global, above, wrong\#args, not enough} -body {
    crimp threshold global above IMAGE
} -returnCodes error -result [wa crimp threshold global above image n]

test crimp-threshold-3.2 {image thresholding, global, above, wrong\#args, too many} -body {
    crimp threshold global above IMAGE THRESHOLD toomuch
} -returnCodes error -result [wa crimp threshold global above image n]

test crimp-threshold-3.3.0 {image thresholding, global, above, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global above [grey8] 0]]
} -result [trim {
    .****
    *****
    *****
    *****
    *****}]

test crimp-threshold-3.3.1 {image thresholding, global, above, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global above [grey8] 1]]
} -result [trim {
    ..***
    *****
    *****
    *****
    *****}]

test crimp-threshold-3.3.2 {image thresholding, global, above, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global above [grey8] 20]]
} -result [trim {
    .....
    .....
    .....
    .....
    .****}]

test crimp-threshold-3.3.3 {image thresholding, global, above, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global above [grey8] 255]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-3.3.4 {image thresholding, global, above, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global above [grey8] 256]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-3.4.0 {image thresholding, global, above, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgb] 0]]
} -result [trim {
    {.**}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-3.4.1 {image thresholding, global, above, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgb] 1]]
} -result [trim {
    {..*}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-3.4.2 {image thresholding, global, above, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgb] 20]]
} -result [trim {
    {...}{..*}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}}]

test crimp-threshold-3.4.3 {image thresholding, global, above, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgb] 255]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-3.4.4 {image thresholding, global, above, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgb] 256]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-3.5.0 {image thresholding, global, above, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgba] 0]]
    # alpha channel is not thresholded
} -result [trim {
    {.**75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-3.5.1 {image thresholding, global, above, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgba] 1]]
    # alpha channel is not thresholded
} -result [trim {
    {..*75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-3.5.2 {image thresholding, global, above, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgba] 20]]
} -result [trim {
    {...75}{..*84}{***85}{***86}{***87}
    {...76}{.**83}{***9.}{***89}{***88}
    {...77}{.**82}{***91}{***98}{***97}
    {...78}{.**81}{***92}{***99}{***96}
    {...79}{.**8.}{***93}{***94}{***95}}]

test crimp-threshold-3.5.3 {image thresholding, global, above, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgba] 255]]
} -result [trim {
    {...75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-3.5.4 {image thresholding, global, above, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global above [rgba] 256]]
} -result [trim {
    {...75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-3.6.0 {image thresholding, global, above, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global above [hsv] 0]]
} -result [trim {
    {.**}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-3.6.1 {image thresholding, global, above, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global above [hsv] 1]]
} -result [trim {
    {..*}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-3.6.2 {image thresholding, global, above, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global above [hsv] 20]]
} -result [trim {
    {...}{..*}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}}]

test crimp-threshold-3.6.3 {image thresholding, global, above, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global above [hsv] 255]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-3.6.4 {image thresholding, global, above, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global above [hsv] 256]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-3.7.0 {image thresholding, global, above, float} -body {
    bw [crimp write 2string tcl [crimp threshold global above [float] 0]]
} -result [trim {
    .****
    *****
    *****
    *****
    *****}]

test crimp-threshold-3.7.1 {image thresholding, global, above, float} -body {
    bw [crimp write 2string tcl [crimp threshold global above [float] -1]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-3.7.2 {image thresholding, global, above, float} -body {
    bw [crimp write 2string tcl [crimp threshold global above [float] 1]]
} -result [trim {
    ..***
    *****
    *****
    *****
    *****}]

test crimp-threshold-3.7.3 {image thresholding, global, above, float} -body {
    bw [crimp write 2string tcl [crimp threshold global above [float] 15.5]]
} -result [trim {
    .....
    .....
    .....
    .****
    *****}]

test crimp-threshold-3.7.4 {image thresholding, global, above, float} -body {
    bw [crimp write 2string tcl [crimp threshold global above [float] 20]]
} -result [trim {
    .....
    .....
    .....
    .....
    .****}]

test crimp-threshold-3.7.5 {image thresholding, global, above, float} -body {
    bw [crimp write 2string tcl [crimp threshold global above [float] 255]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-3.7.6 {image thresholding, global, above, float} -body {
    bw [crimp write 2string tcl [crimp threshold global above [float] 256]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

# -------------------------------------------------------------------------

test crimp-threshold-4.0 {image thresholding, global, inside, wrong\#args, not enough} -body {
    crimp threshold global inside
} -returnCodes error -result [wa crimp threshold global inside image min max]

test crimp-threshold-4.1 {image thresholding, global, inside, wrong\#args, not enough} -body {
    crimp threshold global inside IMAGE
} -returnCodes error -result [wa crimp threshold global inside image min max]

test crimp-threshold-4.2 {image thresholding, global, inside, wrong\#args, not enough} -body {
    crimp threshold global inside IMAGE MIN
} -returnCodes error -result [wa crimp threshold global inside image min max]

test crimp-threshold-4.3 {image thresholding, global, inside, wrong\#args, too many} -body {
    crimp threshold global inside IMAGE MIN MAX toomuch
} -returnCodes error -result [wa crimp threshold global inside image min max]

# Note: For a first set the 'inside' tests use pixel ranges which emulate 'below'.

test crimp-threshold-4.4.0 {image thresholding, global, inside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [grey8] 0 0]]
} -result [trim {
    *....
    .....
    .....
    .....
    .....}]

test crimp-threshold-4.4.1 {image thresholding, global, inside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [grey8] 0 1]]
} -result [trim {
    **...
    .....
    .....
    .....
    .....}]

test crimp-threshold-4.4.2 {image thresholding, global, inside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [grey8] 0 20]]
} -result [trim {
    *****
    *****
    *****
    *****
    *....}]

test crimp-threshold-4.4.3 {image thresholding, global, inside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [grey8] 0 255]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-4.4.4 {image thresholding, global, inside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [grey8] 0 256]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-4.5.0 {image thresholding, global, inside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgb] 0 0]]
} -result [trim {
    {*..}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-4.5.1 {image thresholding, global, inside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgb] 0 1]]
} -result [trim {
    {**.}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-4.5.2 {image thresholding, global, inside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgb] 0 20]]
} -result [trim {
    {***}{**.}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}}]

test crimp-threshold-4.5.3 {image thresholding, global, inside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgb] 0 255]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-4.5.4 {image thresholding, global, inside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgb] 0 256]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-4.6.0 {image thresholding, global, inside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgba] 0 0]]
    # alpha channel is not thresholded
} -result [trim {
    {*..75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-4.6.1 {image thresholding, global, inside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgba] 0 1]]
    # alpha channel is not thresholded
} -result [trim {
    {**.75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-4.6.2 {image thresholding, global, inside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgba] 0 20]]
} -result [trim {
    {***75}{**.84}{...85}{...86}{...87}
    {***76}{*..83}{...9.}{...89}{...88}
    {***77}{*..82}{...91}{...98}{...97}
    {***78}{*..81}{...92}{...99}{...96}
    {***79}{*..8.}{...93}{...94}{...95}}]

test crimp-threshold-4.6.3 {image thresholding, global, inside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgba] 0 255]]
} -result [trim {
    {***75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-4.6.4 {image thresholding, global, inside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [rgba] 0 256]]
} -result [trim {
    {***75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-4.7.0 {image thresholding, global, inside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [hsv] 0 0]]
} -result [trim {
    {*..}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-4.7.1 {image thresholding, global, inside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [hsv] 0 1]]
} -result [trim {
    {**.}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-4.7.2 {image thresholding, global, inside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [hsv] 0 20]]
} -result [trim {
    {***}{**.}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}
    {***}{*..}{...}{...}{...}}]

test crimp-threshold-4.7.3 {image thresholding, global, inside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [hsv] 0 255]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-4.7.4 {image thresholding, global, inside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [hsv] 0 256]]
} -result [trim {
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-4.8.0 {image thresholding, global, inside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [float] 0 0]]
} -result [trim {
    *....
    .....
    .....
    .....
    .....}]

test crimp-threshold-4.8.1 {image thresholding, global, inside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [float] 0 -1]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-4.8.2 {image thresholding, global, inside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [float] 0 1]]
} -result [trim {
    **...
    .....
    .....
    .....
    .....}]

test crimp-threshold-4.8.3 {image thresholding, global, inside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [float] 0 15.5]]
} -result [trim {
    *****
    *****
    *****
    *....
    .....}]

test crimp-threshold-4.8.4 {image thresholding, global, inside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [float] 0 20]]
} -result [trim {
    *****
    *****
    *****
    *****
    *....}]

test crimp-threshold-4.8.5 {image thresholding, global, inside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [float] 0 255]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-4.8.6 {image thresholding, global, inside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global inside [float] 0 256]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

# -------------------------------------------------------------------------

test crimp-threshold-5.0 {image thresholding, global, outside, wrong\#args, not enough} -body {
    crimp threshold global outside
} -returnCodes error -result [wa crimp threshold global outside image min max]

test crimp-threshold-5.1 {image thresholding, global, outside, wrong\#args, not enough} -body {
    crimp threshold global outside IMAGE
} -returnCodes error -result [wa crimp threshold global outside image min max]

test crimp-threshold-5.2 {image thresholding, global, outside, wrong\#args, not enough} -body {
    crimp threshold global outside IMAGE MIN
} -returnCodes error -result [wa crimp threshold global outside image min max]

test crimp-threshold-5.3 {image thresholding, global, outside, wrong\#args, too many} -body {
    crimp threshold global outside IMAGE MIN MAX toomuch
} -returnCodes error -result [wa crimp threshold global outside image min max]

# Note: For a first set the 'outside' tests use pixel ranges which emulate 'above'.

test crimp-threshold-5.4.0 {image thresholding, global, outside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [grey8] 0 0]]
} -result [trim {
    .****
    *****
    *****
    *****
    *****}]

test crimp-threshold-5.4.1 {image thresholding, global, outside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [grey8] 0 1]]
} -result [trim {
    ..***
    *****
    *****
    *****
    *****}]

test crimp-threshold-5.4.2 {image thresholding, global, outside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [grey8] 0 20]]
} -result [trim {
    .....
    .....
    .....
    .....
    .****}]

test crimp-threshold-5.4.3 {image thresholding, global, outside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [grey8] 0 255]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-5.4.4 {image thresholding, global, outside, grey8} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [grey8] 0 256]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-5.5.0 {image thresholding, global, outside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgb] 0 0]]
} -result [trim {
    {.**}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-5.5.1 {image thresholding, global, outside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgb] 0 1]]
} -result [trim {
    {..*}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-5.5.2 {image thresholding, global, outside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgb] 0 20]]
} -result [trim {
    {...}{..*}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}}]

test crimp-threshold-5.5.3 {image thresholding, global, outside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgb] 0 255]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-5.5.4 {image thresholding, global, outside, rgb} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgb] 0 256]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-5.6.0 {image thresholding, global, outside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgba] 0 0]]
    # alpha channel is not thresholded
} -result [trim {
    {.**75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-5.6.1 {image thresholding, global, outside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgba] 0 1]]
    # alpha channel is not thresholded
} -result [trim {
    {..*75}{***84}{***85}{***86}{***87}
    {***76}{***83}{***9.}{***89}{***88}
    {***77}{***82}{***91}{***98}{***97}
    {***78}{***81}{***92}{***99}{***96}
    {***79}{***8.}{***93}{***94}{***95}}]

test crimp-threshold-5.6.2 {image thresholding, global, outside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgba] 0 20]]
} -result [trim {
    {...75}{..*84}{***85}{***86}{***87}
    {...76}{.**83}{***9.}{***89}{***88}
    {...77}{.**82}{***91}{***98}{***97}
    {...78}{.**81}{***92}{***99}{***96}
    {...79}{.**8.}{***93}{***94}{***95}}]

test crimp-threshold-5.6.3 {image thresholding, global, outside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgba] 0 255]]
} -result [trim {
    {...75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-5.6.4 {image thresholding, global, outside, rgba} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [rgba] 0 256]]
} -result [trim {
    {...75}{...84}{...85}{...86}{...87}
    {...76}{...83}{...9.}{...89}{...88}
    {...77}{...82}{...91}{...98}{...97}
    {...78}{...81}{...92}{...99}{...96}
    {...79}{...8.}{...93}{...94}{...95}}]

test crimp-threshold-5.7.0 {image thresholding, global, outside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [hsv] 0 0]]
} -result [trim {
    {.**}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-5.7.1 {image thresholding, global, outside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [hsv] 0 1]]
} -result [trim {
    {..*}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}
    {***}{***}{***}{***}{***}}]

test crimp-threshold-5.7.2 {image thresholding, global, outside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [hsv] 0 20]]
} -result [trim {
    {...}{..*}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}
    {...}{.**}{***}{***}{***}}]

test crimp-threshold-5.7.3 {image thresholding, global, outside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [hsv] 0 255]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-5.7.4 {image thresholding, global, outside, hsv} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [hsv] 0 256]]
} -result [trim {
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}
    {...}{...}{...}{...}{...}}]

test crimp-threshold-5.8.0 {image thresholding, global, outside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [float] 0 0]]
} -result [trim {
    .****
    *****
    *****
    *****
    *****}]

test crimp-threshold-5.8.1 {image thresholding, global, outside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [float] 0 -1]]
} -result [trim {
    *****
    *****
    *****
    *****
    *****}]

test crimp-threshold-5.8.2 {image thresholding, global, outside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [float] 0 1]]
} -result [trim {
    ..***
    *****
    *****
    *****
    *****}]

test crimp-threshold-5.8.3 {image thresholding, global, outside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [float] 0 15.5]]
} -result [trim {
    .....
    .....
    .....
    .****
    *****}]

test crimp-threshold-5.8.4 {image thresholding, global, outside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [float] 0 20]]
} -result [trim {
    .....
    .....
    .....
    .....
    .****}]

test crimp-threshold-5.8.5 {image thresholding, global, outside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [float] 0 255]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

test crimp-threshold-5.8.6 {image thresholding, global, outside, float} -body {
    bw [crimp write 2string tcl [crimp threshold global outside [float] 0 256]]
} -result [trim {
    .....
    .....
    .....
    .....
    .....}]

# -------------------------------------------------------------------------

test crimp-threshold-6.0 {image thresholding, global, otsu, wrong\#args, not enough} -body {
    crimp threshold global otsu
} -returnCodes error -result [wa crimp threshold global otsu image]

test crimp-threshold-6.1 {image thresholding, global, otsu, wrong\#args, too many} -body {
    crimp threshold global otsu IMAGE toomuch
} -returnCodes error -result [wa crimp threshold global otsu image]

test crimp-threshold-6.2 {image thresholding, global, otsu, grey8} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics otsu [crimp statistics basic $image]] otsu] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global otsu $image]]]
    }} [grey8]
    # otsu = 11
} -result [list 11 [trim {
    .....
    .....
    ..***
    *****
    *****}]]

test crimp-threshold-6.3 {image thresholding, global, otsu, rgb} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics otsu [crimp statistics basic $image]] otsu] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global otsu $image]]]
    }} [rgb]
    # otsu/R = 30
    # otsu/G = 31
    # otsu/B = 36
} -result [list {30 31 36} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}}]]

test crimp-threshold-6.4 {image thresholding, global, otsu, rgba} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics otsu [crimp statistics basic $image]] otsu] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global otsu $image]]]
    }} [rgba]
    # otsu/R = 30
    # otsu/G = 31
    # otsu/B = 36
    # otsu/A = 86

} -result [list {30 31 36 86} [trim {
    {....}{....}{....}{***.}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}}]]

test crimp-threshold-6.5 {image thresholding, global, otsu, hsv} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics otsu [crimp statistics basic $image]] otsu] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global otsu $image]]]
    }} [hsv]
    # otsu/H = 30
    # otsu/S = 31
    # otsu/V = 36
} -result [list {30 31 36} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}}]]

test crimp-threshold-6.6 {image thresholding, global, otsu, float} -body {
    # We don't have otsu statistics for floating point numbers/images.
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics otsu [crimp statistics basic $image]] otsu] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global otsu $image]]]
    }} [float]
    # otsu = 
} -result N/A -constraints NotSupported

# -------------------------------------------------------------------------

test crimp-threshold-7.0 {image thresholding, global, middle, wrong\#args, not enough} -body {
    crimp threshold global middle
} -returnCodes error -result [wa crimp threshold global middle image]

test crimp-threshold-7.1 {image thresholding, global, middle, wrong\#args, too many} -body {
    crimp threshold global middle IMAGE toomuch
} -returnCodes error -result [wa crimp threshold global middle image]

test crimp-threshold-7.2 {image thresholding, global, middle, grey8} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] middle] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global middle $image]]]
    }} [grey8]
    # middle = (min+max)/2 = (0+24)/2 = 12
} -result [list 12.0 [trim {
    .....
    .....
    ...**
    *****
    *****}]]

test crimp-threshold-7.3 {image thresholding, global, middle, rgb} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] middle] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global middle $image]]]
    }} [rgb]
    # middle/R = (min/R+max/R)/2 = (0+73)/2 = 36.5
    # middle/G = (min/G+max/G)/2 = (1+69)/2 = 35
    # middle/B = (min/B+max/B)/2 = (2+74)/2 = 38
} -result [list {36.5 35.0 38.0} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}}]]

test crimp-threshold-7.4 {image thresholding, global, middle, rgba} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] middle] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global middle $image]]]
    }} [rgba]
    # middle/R = (min/R+max/R)/2 = ( 0+73)/2 = 36.5
    # middle/G = (min/G+max/G)/2 = ( 1+69)/2 = 35
    # middle/B = (min/B+max/B)/2 = ( 2+74)/2 = 38
    # middle/A = (min/A+max/A)/2 = (75+99)/2 = 87

} -result [list {36.5 35.0 38.0 87.0} [trim {
    {....}{....}{....}{***.}{***.}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}}]]

test crimp-threshold-7.5 {image thresholding, global, middle, hsv} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] middle] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global middle $image]]]
    }} [hsv]
    # middle/H = (min/H+max/H)/2 = (0+73)/2 = 36.5
    # middle/S = (min/S+max/S)/2 = (1+69)/2 = 35
    # middle/V = (min/V+max/V)/2 = (2+74)/2 = 38
} -result [list {36.5 35.0 38.0} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}}]]

test crimp-threshold-7.6 {image thresholding, global, middle, float} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] middle] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global middle $image]]]
    }} [float]
    # middle = (min+max)/2 = (0+24)/2 = 12
} -result [list 12.0 [trim {
    .....
    .....
    ...**
    *****
    *****}]]

# -------------------------------------------------------------------------

test crimp-threshold-8.0 {image thresholding, global, mean, wrong\#args, not enough} -body {
    crimp threshold global mean
} -returnCodes error -result [wa crimp threshold global mean image]

test crimp-threshold-8.1 {image thresholding, global, mean, wrong\#args, too many} -body {
    crimp threshold global mean IMAGE toomuch
} -returnCodes error -result [wa crimp threshold global mean image]

test crimp-threshold-8.2 {image thresholding, global, mean, grey8} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] mean] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global mean $image]]]
    }} [grey8]
    # mean = 12.0
} -result [list 12.0 [trim {
    .....
    .....
    ...**
    *****
    *****}]]

test crimp-threshold-8.3 {image thresholding, global, mean, rgb} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] mean] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global mean $image]]]
    }} [rgb]
    # mean/R = 35.92
    # mean/G = 37.08
    # mean/B = 38.0
} -result [list {35.92 37.08 38.0} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{*..}{***}{***}}]]

test crimp-threshold-8.4 {image thresholding, global, mean, rgba} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] mean] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global mean $image]]]
    }} [rgba]
    # mean/R = 35.92
    # mean/G = 37.08
    # mean/B = 38.0
    # mean/A = 87.0
} -result [list {35.92 37.08 38.0 87.0} [trim {
    {....}{....}{....}{***.}{***.}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{*..*}{****}{****}}]]

test crimp-threshold-8.5 {image thresholding, global, mean, hsv} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] mean] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global mean $image]]]
    }} [hsv]
    # mean/H = 35.92
    # mean/S = 37.08
    # mean/V = 38.0
} -result [list {35.92 37.08 38.0} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{*..}{***}{***}}]]

test crimp-threshold-8.6 {image thresholding, global, mean, float} -body {
    # We don't have mean statistics for floating point numbers/images.
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] mean] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global mean $image]]]
    }} [float]
    # mean = 12.0
} -result [list 12.0 [trim {
    .....
    .....
    ...**
    *****
    *****}]]

# -------------------------------------------------------------------------

test crimp-threshold-9.0 {image thresholding, global, median, wrong\#args, not enough} -body {
    crimp threshold global median
} -returnCodes error -result [wa crimp threshold global median image]

test crimp-threshold-9.1 {image thresholding, global, median, wrong\#args, too many} -body {
    crimp threshold global median IMAGE toomuch
} -returnCodes error -result [wa crimp threshold global median image]

test crimp-threshold-9.2 {image thresholding, global, median, grey8} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] median] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global median $image]]]
    }} [grey8]
    # median = 12
} -result [list 12 [trim {
    .....
    .....
    ...**
    *****
    *****}]]

test crimp-threshold-9.3 {image thresholding, global, median, rgb} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] median] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global median $image]]]
    }} [rgb]
    # median/R = 39
    # median/G = 42
    # median/B = 34
} -result [list {39 42 34} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{*..}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{.**}{***}{***}
    {...}{...}{..*}{***}{***}}]]

test crimp-threshold-9.4 {image thresholding, global, median, rgba} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] median] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global median $image]]]
    }} [rgba]
    # median/R = 39
    # median/G = 42
    # median/B = 34
    # median/A = 87

} -result [list {39 42 34 87} [trim {
    {....}{....}{....}{***.}{***.}
    {....}{....}{*..*}{****}{****}
    {....}{....}{**.*}{****}{****}
    {....}{....}{.***}{****}{****}
    {....}{....}{..**}{****}{****}}]]

test crimp-threshold-9.5 {image thresholding, global, median, hsv} -body {
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] median] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global median $image]]]
    }} [hsv]
    # median/H = 39
    # median/S = 42
    # median/V = 34
} -result [list {39 42 34} [trim {
    {...}{...}{...}{***}{***}
    {...}{...}{*..}{***}{***}
    {...}{...}{**.}{***}{***}
    {...}{...}{.**}{***}{***}
    {...}{...}{..*}{***}{***}}]]

test crimp-threshold-9.6 {image thresholding, global, median, float} -body {
    # We don't have median statistics for floating point numbers/images.
    apply {{image} {
        list \
            [lmap [list cstat [crimp statistics basic $image] median] [crimp channels $image]] \
            [bw [crimp write 2string tcl [crimp threshold global median $image]]]
    }} [float]
    # median = N/A
} -result N/A -constraints NotSupported

# -------------------------------------------------------------------------
## Handling of input location: Pass through.

foreach {n itype cando} {
    0 grey8 {}
    1 rgb   {}
    2 rgba  {}
    3 hsv   {}
    4 float NotSupported
} {
    test crimp-threshold-7.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global below [crimp place [$itype] 23 45] 25]
    } -result {23 45}

    test crimp-threshold-8.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global above [crimp place [$itype] 23 45] 25]
    } -result {23 45}

    test crimp-threshold-9.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global inside [crimp place [$itype] 23 45] 25 50]
    } -result {23 45}

    test crimp-threshold-10.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global outside [crimp place [$itype] 23 45] 25 50]
    } -result {23 45}

    test crimp-threshold-11.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global otsu [crimp place [$itype] 23 45]]
    } -result {23 45} -constraints $cando

    test crimp-threshold-12.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global middle [crimp place [$itype] 23 45]]
    } -result {23 45}

    test crimp-threshold-13.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global mean [crimp place [$itype] 23 45]]
    } -result {23 45}

    test crimp-threshold-14.$n "image thresholding, $itype, location handling" -body {
	crimp at [crimp threshold global median [crimp place [$itype] 23 45]]
    } -result {23 45} -constraints $cando
}

# -------------------------------------------------------------------------
cleanupTests

# Local variables:
# mode: tcl
# indent-tabs-mode: nil
# End:
