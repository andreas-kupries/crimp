# -*- tcl -*-
# -------------------------------------------------------------------------

source [file join \
            [file dirname [file join [pwd] [info script]]] \
            testutilities.tcl]

testsNeedTcl     8.5
testsNeedTcltest 2

support { useLocalFile synth.tcl }
support { useC [mainPath _test/lib]/crimp_core* crimp::core no }
testing { useC [mainPath _test/lib]/crimp*      crimp       no }

# -------------------------------------------------------------------------
## Geometry manipulation. Warp image through a general coordinate field.
## (x/y coordinate fields for result, sampling into the input).
# -------------------------------------------------------------------------

test crimp-warp-field-1.0 {image warp field, wrong\#args, not enough} -body {
    crimp warp field
} -returnCodes error -result {wrong # args: should be "::crimp::warp::field image xvec yvec"}

test crimp-warp-field-1.1 {image warp field, wrong\#args, not enough} -body {
    crimp warp field IMAGE
} -returnCodes error -result {wrong # args: should be "::crimp::warp::field image xvec yvec"}

test crimp-warp-field-1.2 {image warp field, wrong\#args, not enough} -body {
    crimp warp field IMAGE X
} -returnCodes error -result {wrong # args: should be "::crimp::warp::field image xvec yvec"}

test crimp-warp-field-1.3 {image warp field, wrong\#args, too many} -body {
    crimp warp field IMAGE X Y toomuch
} -returnCodes error -result {wrong # args: should be "::crimp::warp::field image xvec yvec"}

test crimp-warp-field-1.4 {image warp field, invalid arguments, bad option} -body {
    crimp warp field -bogus FOO
} -returnCodes error -result {Expected -interpolate, got "-bogus"}

test crimp-warp-field-1.5 {image warp field, invalid arguments, bad option} -body {
    crimp warp field -interpolate FOO
} -returnCodes error -result {Expected one of nneighbour, bilinear, or bicubic, got "FOO"}

# 3 args: input, x, y
# option -interpolate: bilinear (default), bicubic, nneighbour
# supported inputs: grey8 grey16 grey32 rgb rgba hsv float fpcomplex
# TODO implementation: coordinate samples via single fpcomplex, instead of two separate images.

# Note: coordinate samplers must be convertible to (float x2)
#       => grey8, grey16, grey32, float, but not rgb, rgba, hsv

# TODO: rgb rgba hsv warping

# -------------------------------------------------------------------------

set n 2
foreach itype [greys] {
    test crimp-warp-field-${n}.0 "image warp field, $itype, nearest neighbour" -body {
        astcl [crimp warp field -interpolate nneighbour [$itype] [sample] [sample]]
        # permutations of the main diagonal
    } -result [iconst $itype 0 0 5 5 {
         0  6 12 18 24
         6 12 18 24  0
        12 18 24  0  6
        18 24  0  6 12
        24  0  6 12 18
    }]

    test crimp-warp-field-${n}.1 "image warp field, $itype, nearest neighbour" -body {
        astcl [crimp warp field -interpolate nneighbour [$itype] [crimp flip transverse [sample]] [sample]]
    } -result [iconst $itype 0 0 5 5 {
         3  7 11 15 24
         7 11 15 24  3
        11 15 24  3  7
        15 24  3  7 11
        24  3  7 11 15
    }]

    # validate...
    test crimp-warp-field-${n}.2 "image warp field, $itype, bilinear (default)" -body {
        astcl [crimp warp field [$itype] [sample] [sample]]
    } -result [iconst $itype 0 0 5 5 {
         1  6 12 20 11
         7 13 18 24  2
        14 19 15  0  6
        18  8  1  7 12
        19  0  8 13 19
    }]

    test crimp-warp-field-${n}.3 "image warp field, $itype, bilinear (default)" -body {
        astcl [crimp warp field [$itype] [crimp flip transverse [sample]] [sample]]
    } -result [iconst $itype 0 0 5 5 {
         4  7 11 17 11
         8 12 15 24  5
        13 16 15  3  7
        15  8  4  8 11
        19  3  9 12 16
    }]

    test crimp-warp-field-${n}.4 "image warp field, $itype, bicubic" -body {
        astcl [crimp warp field -interpolate bicubic [$itype] [sample] [sample]]

    } -result [iconst $itype 0 0 5 5 {
         2  8 13 23  8
         8 14 22 12  2
        14 23  9  1  7
        21  7  2  8 14
        10  1  8 14 22
    }]

    test crimp-warp-field-${n}.5 "image warp field, $itype, bicubic" -body {
        astcl [crimp warp field -interpolate bicubic [$itype] [crimp flip transverse [sample]] [sample]]
    } -result [iconst $itype 0 0 5 5 {
         5  9 12 20  8
         9 13 19 12  6
        13 20  9  5  8
        19  7  5  9 13
        10  5  9 13 19
    }]

    incr n
}


test crimp-warp-field-5.0 "image warp field, float, nearest neighbour" -body {
    astclf 4 [crimp warp field -interpolate nneighbour [float] [sample] [sample]]
    # permutations of the main diagonal
} -result [iconst float 0 0 5 5 {
     0.0000   6.0000  12.0000  18.0000  24.0000
     6.0000  12.0000  18.0000  24.0000   0.0000
    12.0000  18.0000  24.0000   0.0000   6.0000
    18.0000  24.0000   0.0000   6.0000  12.0000
    24.0000   0.0000   6.0000  12.0000  18.0000
}]

test crimp-warp-field-5.1 "image warp field, float, nearest neighbour" -body {
    astclf 4 [crimp warp field -interpolate nneighbour [float] [crimp flip transverse [sample]] [sample]]
} -result [iconst float 0 0 5 5 {
     3.0000   7.0000  11.0000  15.0000  24.0000
     7.0000  11.0000  15.0000  24.0000   3.0000
    11.0000  15.0000  24.0000   3.0000   7.0000
    15.0000  24.0000   3.0000   7.0000  11.0000
    24.0000   3.0000   7.0000  11.0000  15.0000
}]

# validate...
test crimp-warp-field-5.2 "image warp field, float, bilinear (default)" -body {
    astclf 4 [crimp warp field [float] [sample] [sample]]
} -result [iconst float 0 0 5 5 {
     1.2000   6.6000  12.0000  20.4000  11.7600
     7.8000  13.2000  18.6000  24.0000   2.4000
    14.4000  19.8000  15.3600   0.6000   6.0000
    18.0000   8.6400   1.8000   7.2000  12.6000
    19.4400   0.0000   8.4000  13.8000  19.2000
}]

test crimp-warp-field-5.3 "image warp field, float, bilinear (default)" -body {
    astclf 4 [crimp warp field [float] [crimp flip transverse [sample]] [sample]]
} -result [iconst float 0 0 5 5 {
     4.2000   7.6000  11.0000  17.4000  11.7600
     8.8000  12.2000  15.6000  24.0000   5.4000
    13.4000  16.8000  15.3600   3.6000   7.0000
    15.0000   8.6400   4.8000   8.2000  11.6000
    19.4400   3.0000   9.4000  12.8000  16.2000
}]

test crimp-warp-field-5.4 "image warp field, float, bicubic" -body {
    astclf 4 [crimp warp field -interpolate bicubic [float] [sample] [sample]]

} -result [iconst float 0 0 5 5 {
     2.1097   8.2000  14.0000  23.8513   8.4018
     8.6000  14.4000  22.3916  12.1975   2.5612
    14.8000  23.3770   9.6146   1.8881   8.0000
    21.8930   7.2564   2.3344   8.4000  14.2000
    10.8841   1.6708   8.8000  14.6000  22.8883
}]

test crimp-warp-field-5.5 "image warp field, float, bicubic" -body {
    astclf 4 [crimp warp field -interpolate bicubic [float] [crimp flip transverse [sample]] [sample]]
} -result [iconst float 0 0 5 5 {
     5.6208   9.2000  13.0000  20.4555   8.4018
     9.6000  13.4000  19.5194  12.1975   6.1241
    13.8000  20.1668   9.6146   5.3708   9.0000
    19.1646   7.2564   5.8723   9.4000  13.2000
    10.8841   5.1235   9.8000  13.6000  19.8541
}]

test crimp-warp-field-6.0 "image warp field, fpcomplex, nearest neighbour" -body {
    astclf 4 [crimp warp field -interpolate nneighbour [fpcomplex] [sample] [sample]]
    # permutations of the main diagonal
} -result [iconst fpcomplex 0 0 5 5 {
    { 1.0000  1.0000} {21.0000 21.0000} {43.0000 43.0000} {49.0000 49.0000} {65.0000 65.0000}
    {21.0000 21.0000} {43.0000 43.0000} {49.0000 49.0000} {65.0000 65.0000} { 1.0000  1.0000}
    {43.0000 43.0000} {49.0000 49.0000} {65.0000 65.0000} { 1.0000  1.0000} {21.0000 21.0000}
    {49.0000 49.0000} {65.0000 65.0000} { 1.0000  1.0000} {21.0000 21.0000} {43.0000 43.0000}
    {65.0000 65.0000} { 1.0000  1.0000} {21.0000 21.0000} {43.0000 43.0000} {49.0000 49.0000}
}]

test crimp-warp-field-6.1 "image warp field, fpcomplex, nearest neighbour" -body {
    astclf 4 [crimp warp field -interpolate nneighbour [fpcomplex] [crimp flip transverse [sample]] [sample]]
} -result [iconst fpcomplex 0 0 5 5 {
    {58.0000 58.0000} {42.0000 42.0000} {22.0000 22.0000} {10.0000 10.0000} {65.0000 65.0000}
    {42.0000 42.0000} {22.0000 22.0000} {10.0000 10.0000} {65.0000 65.0000} {58.0000 58.0000}
    {22.0000 22.0000} {10.0000 10.0000} {65.0000 65.0000} {58.0000 58.0000} {42.0000 42.0000}
    {10.0000 10.0000} {65.0000 65.0000} {58.0000 58.0000} {42.0000 42.0000} {22.0000 22.0000}
    {65.0000 65.0000} {58.0000 58.0000} {42.0000 42.0000} {22.0000 22.0000} {10.0000 10.0000}
}]

# validate...
test crimp-warp-field-6.2 "image warp field, fpcomplex, bilinear (default)" -body {
    astclf 4 [crimp warp field [fpcomplex] [sample] [sample]]
} -result [iconst fpcomplex 0 0 5 5 {
    { 3.5200  3.5200} {18.5800 18.5800} {40.0000 40.0000} {56.0800 56.0800} {31.3600 31.3600}
    {23.6200 23.6200} {42.0000 42.0000} {51.5800 51.5800} {64.0000 64.0000} { 6.8800  6.8800}
    {44.0000 44.0000} {54.6200 54.6200} {40.9600 40.9600} { 1.7800  1.7800} {16.0000 16.0000}
    {50.0000 50.0000} {23.0400 23.0400} { 5.2200  5.2200} {21.1200 21.1200} {41.0000 41.0000}
    {51.8400 51.8400} { 0.0000  0.0000} {26.0800 26.0800} {43.0000 43.0000} {53.1200 53.1200}
}]

test crimp-warp-field-6.3 "image warp field, fpcomplex, bilinear (default)" -body {
    astclf 4 [crimp warp field [fpcomplex] [crimp flip transverse [sample]] [sample]]
} -result [iconst fpcomplex 0 0 5 5 {
    {57.7600 57.7600} {42.3600 42.3600} {17.0000 17.0000} {13.4800 13.4800} {31.3600 31.3600}
    {44.8400 44.8400} {21.7200 21.7200} {10.1800 10.1800} {64.0000 64.0000} {59.2400 59.2400}
    {26.2800 26.2800} {12.4200 12.4200} {40.9600 40.9600} {57.2900 57.2900} {41.0000 41.0000}
    { 9.0000  9.0000} {23.0400 23.0400} {58.4100 58.4100} {43.6400 43.6400} {19.3800 19.3800}
    {51.8400 51.8400} {57.0000 57.0000} {45.9600 45.9600} {24.0200 24.0200} {11.3200 11.3200}
}]

test crimp-warp-field-6.4 "image warp field, fpcomplex, bicubic" -body {
    astclf 4 [crimp warp field -interpolate bicubic [fpcomplex] [sample] [sample]]
} -result [iconst fpcomplex 0 0 5 5 {
    { 5.8973  8.8692} {25.1675 29.3998} {43.7023 46.8285} {64.7165 62.4266} {22.2327 22.9716}
    {27.0234 31.0397} {44.2212 47.2401} {60.9996 58.5299} {32.3073 33.3100} { 7.0436 10.3904}
    {44.7285 47.5503} {63.5119 61.1303} {25.4488 26.2789} { 5.3210  8.1015} {24.2414 28.5802}
    {59.7257 57.2606} {19.1978 19.8455} { 6.4724  9.6335} {26.0961 30.2205} {43.9646 47.0478}
    {28.8179 29.7367} { 4.7462  7.3347} {27.9457 31.8550} {44.4749 47.4071} {62.2672 59.8254}
}]

test crimp-warp-field-6.5 "image warp field, fpcomplex, bicubic" -body {
    astclf 4 [crimp warp field -interpolate bicubic [fpcomplex] [crimp flip transverse [sample]] [sample]]
} -result [iconst fpcomplex 0 0 5 5 {
    {68.2623 69.8675} {46.9699 47.9551} {24.3141 29.4321} {14.6271 17.8676} {22.2327 22.9716}
    {47.4532 48.5430} {25.9582 31.1260} {13.4813 16.0909} {32.3073 33.3100} {69.1793 70.2755}
    {27.6126 32.8517} {14.2531 17.2789} {25.4488 26.2789} {67.7167 69.4848} {46.6735 47.6132}
    {13.0850 15.4966} {19.1978 19.8455} {68.7491 70.1306} {47.2284 48.2641} {25.1336 30.2737}
    {28.8179 29.7367} {67.1097 68.9822} {47.6489 48.7950} {26.7854 31.9864} {13.8709 16.6858}
}]

# -------------------------------------------------------------------------
## Handling of input location: Always (0,0).

# TODO

# -------------------------------------------------------------------------
testsuiteCleanup

# Local variables:
# mode: tcl
# indent-tabs-mode: nil
# End:
