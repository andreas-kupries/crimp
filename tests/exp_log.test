# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0
## (c) 2016 Andreas Kupries
# # ## ### ##### ######## ############# #####################

kt check Tcl     8.5
kt check tcltest 2

kt source support/synth.tcl

kt local support crimp::core
kt local testing crimp

# -------------------------------------------------------------------------
## Pixel-wise exponentiation and logarithms.
# -------------------------------------------------------------------------

set n_float  2
set n_double 4

set e_float [iconst float 0 0 5 5 {
            1.00          2.72          7.39         20.09          54.60
          148.41        403.43       1096.63       2980.96        8103.08 
        22026.46      59874.14     162754.80     442413.41     1202604.25
      3269017.25    8886111.00   24154952.00   65659968.00   178482304.00
    485165184.00 1318815744.00 3584912896.00 9744803840.00 26489122816.00
}]

set e_double [iconst double 0 0 5 5 {
            1.0000          2.7183          7.3891         20.0855          54.5982
          148.4132        403.4288       1096.6332       2980.9580        8103.0839
        22026.4658      59874.1417     162754.7914     442413.3920     1202604.2842
      3269017.3725    8886110.5205   24154952.7536   65659969.1373   178482300.9632
    485165195.4098 1318815734.4832 3584912846.1316 9744803446.2489 26489122129.8435
}]

set l_float [iconst float 0 0 5 5 {
    -inf 0.00 0.69 1.10 1.39
    1.61 1.79 1.95 2.08 2.20
    2.30 2.40 2.48 2.56 2.64
    2.71 2.77 2.83 2.89 2.94
    3.00 3.04 3.09 3.14 3.18
}]

set l_double [iconst double 0 0 5 5 {
    -inf   0.0000 0.6931 1.0986 1.3863
    1.6094 1.7918 1.9459 2.0794 2.1972
    2.3026 2.3979 2.4849 2.5649 2.6391
    2.7081 2.7726 2.8332 2.8904 2.9444
    2.9957 3.0445 3.0910 3.1355 3.1781
}]

set l10_float [iconst float 0 0 5 5 {
    -inf 0.00 0.30 0.48 0.60
    0.70 0.78 0.85 0.90 0.95
    1.00 1.04 1.08 1.11 1.15
    1.18 1.20 1.23 1.26 1.28
    1.30 1.32 1.34 1.36 1.38
}]

set l10_double [iconst double 0 0 5 5 {
    -inf   0.0000 0.3010 0.4771 0.6021
    0.6990 0.7782 0.8451 0.9031 0.9542
    1.0000 1.0414 1.0792 1.1139 1.1461
    1.1761 1.2041 1.2304 1.2553 1.2788
    1.3010 1.3222 1.3424 1.3617 1.3802
}]

set e_grey8 [iconst grey8 0 0 5 5 {
      1   2   7  20  54
    148 255 255 255 255
    255 255 255 255 255
    255 255 255 255 255
    255 255 255 255 255
}]

set e_grey16 [iconst grey16 0 0 5 5 {
        1     2     7    20    54
      148   403  1096  2980  8103
    22026 59874 65535 65535 65535
    65535 65535 65535 65535 65535
    65535 65535 65535 65535 65535
}]

set e_grey32 [iconst grey32 0 0 5 5 {
            1          2          7         20         54
          148        403       1096       2980       8103
        22026      59874     162754     442413    1202604
      3269017    8886110   24154952   65659969  178482300
    485165195 1318815734 2147483648 4294967295 4294967295
}]

foreach itype {grey8 grey16 grey32} {
    set l_$itype [iconst $itype 0 0 5 5 {
        0 0 0 1 1
        1 1 1 2 2
        2 2 2 2 2
        2 2 2 2 2
        2 3 3 3 3
    }]

    set l10_$itype [iconst $itype 0 0 5 5 {
        0 0 0 0 0
        0 0 0 0 0
        1 1 1 1 1
        1 1 1 1 1
        1 1 1 1 1
    }]
}


foreach itype [simples] {
    if {[string match grey* $itype] ||
        [string match r*    $itype] ||
        [string match h*    $itype]} {
        set astcl astcl
    } else {
        set astcl [list astclf [set n_$itype]]
    }
    # - - -- --- ----- --------

    test crimp-exp-${itype}-1.0 "image exp, $itype, wrong\#args, not enough" -body {
        crimp exp
    } -returnCodes error -result [wa crimp exp image]

    test crimp-exp-${itype}-1.1 "image exp, $itype, wrong\#args, too many" -body {
        crimp exp IMAGE X
    } -returnCodes error -result [wa crimp exp image]

    test crimp-exp-${itype}-2.0 "image exp, $itype" -body {
        {*}$astcl [crimp exp [$itype]]
    } -result [set e_$itype]

    test crimp-exp-${itype}-3.0 "image exp ($), input handling" -body {
        crimp at [crimp exp [crimp place [$itype] 4 5]]
    } -result {4 5}

    # - - -- --- ----- --------

    test crimp-log10-${itype}-1.0 "image log10, $itype, wrong\#args, not enough" -body {
        crimp log10
    } -returnCodes error -result [wa crimp log10 image]

    test crimp-log10-${itype}-1.1 "image log10, $itype, wrong\#args, too many" -body {
        crimp log10 IMAGE X
    } -returnCodes error -result [wa crimp log10 image]

    test crimp-log10-${itype}-2.0 "image log10, $itype" -body {
        {*}$astcl [crimp log10 [$itype]]
    } -result [set l10_$itype]

    # - - -- --- ----- --------

    test crimp-log10-${itype}-3.0 "image log10 ($), input handling" -body {
        crimp at [crimp log10 [crimp place [$itype] 4 5]]
    } -result {4 5}

    test crimp-log-${itype}-1.0 "image log, $itype, wrong\#args, not enough" -body {
        crimp log
    } -returnCodes error -result [wa crimp log image]

    test crimp-log-${itype}-1.1 "image log, $itype, wrong\#args, too many" -body {
        crimp log IMAGE X
    } -returnCodes error -result [wa crimp log image]

    test crimp-log-${itype}-2.0 "image log, $itype" -body {
        {*}$astcl [crimp log [$itype]]
    } -result [set l_$itype]

    test crimp-log-${itype}-3.0 "image log ($), input handling" -body {
        crimp at [crimp log [crimp place [$itype] 4 5]]
    } -result {4 5}
}

# TODO: unsupported types - errors on unsupported types
# TODO: error on argument type mismatch

# -------------------------------------------------------------------------
cleanupTests

# Local variables:
# mode: tcl
# indent-tabs-mode: nil
# End:
