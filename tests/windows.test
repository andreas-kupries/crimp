# -*- tcl -*- tcl.tk//DSL tcltest//EN//2.0
## (c) 2016 Andreas Kupries
# # ## ### ##### ######## ############# #####################

kt check Tcl     8.5
kt check tcltest 2

kt source support/synth.tcl

kt local support crimp::core
kt local testing crimp

# -------------------------------------------------------------------------
## Windowing, circular dimming towards the edges from image center.
## - Pixel transformation is location-dependent.
# -------------------------------------------------------------------------

set n_float     2
set n_double    4
set n_fpcomplex 2

set w_float [iconst float 0 0 5 5 {
    0.00  0.30  0.72  0.91 0.52
    1.51  4.23  5.88  5.64 2.72
    3.60  9.24 12.00 10.92 5.04
    4.54 11.29 14.28 12.70 5.75
    2.59  6.35  7.92  6.96 3.11
}]

set w_double [iconst double 0 0 5 5 {
    0.0000  0.3024  0.7200  0.9072 0.5184
    1.5120  4.2336  5.8800  5.6448 2.7216
    3.6000  9.2400 12.0000 10.9200 5.0400
    4.5360 11.2896 14.2800 12.7008 5.7456
    2.5920  6.3504  7.9200  6.9552 3.1104
}]

set w_grey8 [iconst grey8 0 0 5 5 {
    0  0  0  0 0
    1  4  5  5 2
    3  9 12 10 5
    4 11 14 12 5
    2  6  7  6 3
}]

set w_grey16 [iconst grey16 0 0 5 5 {
    0  0  0  0 0
    1  4  5  5 2
    3  9 12 10 5
    4 11 14 12 5
    2  6  7  6 3
}]

set w_grey32 [iconst grey32 0 0 5 5 {
    0  0  0  0 0
    1  4  5  5 2
    3  9 12 10 5
    4 11 14 12 5
    2  6  7  6 3
}]

set w_rgb [iconst rgb 0 0 5 5 {
    {0 0 0} { 4  6  7} {10 11 11} {17 17 17} { 7  8  9}
    {0 1 1} {11 14 18} {34 35 27} {39 38 38} {20 18 21}
    {2 2 2} {14 18 22} {40 43 34} {42 43 44} {26 24 22}
    {2 3 3} {12 16 19} {32 36 29} {35 34 33} {21 19 19}
    {1 1 1} { 5  7  8} {13 13 12} {13 13 14} { 8  8  9}
}]

set w_rgba [iconst rgba 0 0 5 5 {
    {0 0 0 75} { 4  6  7 84} {10 11 11 85} {17 17 17 86} { 7  8  9 87}
    {0 1 1 76} {11 14 18 83} {34 35 27 90} {39 38 38 89} {20 18 21 88}
    {2 2 2 77} {14 18 22 82} {40 43 34 91} {42 43 44 98} {26 24 22 97}
    {2 3 3 78} {12 16 19 81} {32 36 29 92} {35 34 33 99} {21 19 19 96}
    {1 1 1 79} { 5  7  8 80} {13 13 12 93} {13 13 14 94} { 8  8  9 95}
}]

set w_hsv [iconst hsv 0 0 5 5 {
    {0 0 0} { 4  6  7} {10 11 11} {17 17 17} { 7  8  9}
    {0 1 1} {11 14 18} {34 35 27} {39 38 38} {20 18 21}
    {2 2 2} {14 18 22} {40 43 34} {42 43 44} {26 24 22}
    {2 3 3} {12 16 19} {32 36 29} {35 34 33} {21 19 19}
    {1 1 1} { 5  7  8} {13 13 12} {13 13 14} { 8  8  9}
}]

set w_fpcomplex [iconst fpcomplex 0 0 5 5 {
    {0.00 0.13} { 4.54  6.05} {10.80 11.16} {17.24 17.54} { 7.78  8.94}
    {0.91 1.21} {11.29 14.82} {34.44 35.28} {39.51 38.81} {20.56 18.45}
    {2.16 2.52} {14.28 18.48} {40.00 43.00} {42.84 43.68} {26.28 24.12}
    {2.72 3.02} {12.70 16.23} {32.76 36.96} {35.28 34.57} {21.47 19.05}
    {1.56 1.68} { 5.75  7.26} {13.68 13.32} {13.61 13.91} { 8.29  8.42}
}]

foreach itype [types] {
    if {[string match grey* $itype] ||
        [string match r*    $itype] ||
        [string match h*    $itype]} {
        set astcl astcl
    } else {
        set astcl [list astclf [set n_$itype]]
    }
    # - - -- --- ----- --------

    test crimp-window-${itype}-1.0 "image window, $itype, wrong\#args, not enough" -body {
        crimp window
    } -returnCodes error -result [wa crimp window image]

    test crimp-window-${itype}-1.1 "image window, $itype, wrong\#args, too many" -body {
        crimp window IMAGE X
    } -returnCodes error -result [wa crimp window image]
    
    test crimp-window-${itype}-2.0 "image window, $itype" -body {
        {*}$astcl [crimp window [$itype]]
    } -result [set w_$itype]

    test crimp-window-${itype}-3.0 "image window ($), input handling" -body {
        crimp at [crimp window [crimp place [$itype] 4 5]]
    } -result {4 5}
}

# Special tests against "1" (all 1) => result is the window itself
test crimp-window-4.0 "image window, odd window" -body {
    astclf 4 [crimp window [ones 5]]
} -result [iconst double 0 0 5 5 {
    0.1296 0.3024 0.3600 0.3024 0.1296
    0.3024 0.7056 0.8400 0.7056 0.3024
    0.3600 0.8400 1.0000 0.8400 0.3600
    0.3024 0.7056 0.8400 0.7056 0.3024
    0.1296 0.3024 0.3600 0.3024 0.1296
}]

test crimp-window-4.1 "image window, odd window" -body {
    astclf 4 [crimp window [ones 6]]
} -result [iconst double 0 0 6 6 {
    0.0934 0.2292 0.2971 0.2971 0.2292 0.0934
    0.2292 0.5625 0.7292 0.7292 0.5625 0.2292
    0.2971 0.7292 0.9452 0.9452 0.7292 0.2971
    0.2971 0.7292 0.9452 0.9452 0.7292 0.2971
    0.2292 0.5625 0.7292 0.7292 0.5625 0.2292
    0.0934 0.2292 0.2971 0.2971 0.2292 0.0934
}]

# TODO: unsupported types - errors on unsupported types
# TODO: error on argument type mismatch

# -------------------------------------------------------------------------
cleanupTests

# Local variables:
# mode: tcl
# indent-tabs-mode: nil
# End:
